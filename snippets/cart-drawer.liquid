<cart-drawer class="cart-drawer{% if cart == empty %} is-empty{% endif %}">
  <div class="cart-drawer__overlay" data-cart-drawer-close></div>
  
  <div class="cart-drawer__inner">
    <div class="cart-drawer__header">
      <h2 class="cart-drawer__heading">{{ 'sections.cart.title' | t }}</h2>
      <button class="cart-drawer__close" type="button" data-cart-drawer-close aria-label="{{ 'accessibility.close' | t }}">
        {% render 'icon', icon: 'close' %}
      </button>
    </div>

    <div class="cart-drawer__content">
      {%- if cart != empty -%}
        <form action="{{ routes.cart_url }}" method="post" id="CartDrawer">
          <div class="cart-drawer__items" data-cart-items>
            {%- for item in cart.items -%}
              <div class="cart-drawer__item" data-cart-item data-item-key="{{ item.key }}">
                <div class="cart-drawer__item-image">
                  {%- if item.image -%}
                    <a href="{{ item.url }}" tabindex="-1" aria-hidden="true">
                      {{ item.image | image_url: width: 300 | image_tag:
                        loading: 'lazy',
                        widths: '100, 150, 200, 300',
                        sizes: '100px',
                        alt: item.image.alt | escape
                      }}
                    </a>
                  {%- endif -%}
                </div>

                <div class="cart-drawer__item-details">
                  <a href="{{ item.url }}" class="cart-drawer__item-name">
                    {{ item.product.title | escape }}
                  </a>

                  {%- unless item.product.has_only_default_variant -%}
                    <div class="cart-drawer__item-variant">
                      {%- for option in item.options_with_values -%}
                        <span class="product-option">
                          {{ option.name }}: {{ option.value }}
                        </span>
                      {%- endfor -%}
                    </div>
                  {%- endunless -%}

                  {%- for property in item.properties -%}
                    {%- assign property_first_char = property.first | slice: 0 -%}
                    {%- if property.last != blank and property_first_char != '_' -%}
                      <div class="cart-drawer__item-property">
                        <span>{{ property.first }}: </span>
                        {%- if property.last contains '/uploads/' -%}
                          <a href="{{ property.last }}" target="_blank">{{ property.last | split: '/' | last }}</a>
                        {%- else -%}
                          <span>{{ property.last }}</span>
                        {%- endif -%}
                      </div>
                    {%- endif -%}
                  {%- endfor -%}

                  <div class="cart-drawer__item-price">
                    {%- if item.original_line_price != item.final_line_price -%}
                      <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
                      <span class="price price--sale">{{ item.final_line_price | money }}</span>
                      <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
                      <s class="price price--regular">{{ item.original_line_price | money }}</s>
                    {%- else -%}
                      <span class="price">{{ item.original_line_price | money }}</span>
                    {%- endif -%}
                  </div>

                  <div class="cart-drawer__item-quantity">
                    <quantity-input class="quantity">
                      <button class="quantity__button" type="button" name="minus" aria-label="{{ 'products.product.quantity.decrease' | t }}">
                        {% render 'icon', icon: 'minus' %}
                      </button>
                      <input
                        class="quantity__input"
                        type="number"
                        name="updates[]"
                        value="{{ item.quantity }}"
                        min="0"
                        aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                        data-item-key="{{ item.key }}"
                        data-cart-quantity
                      >
                      <button class="quantity__button" type="button" name="plus" aria-label="{{ 'products.product.quantity.increase' | t }}">
                        {% render 'icon', icon: 'plus' %}
                      </button>
                    </quantity-input>

                    <cart-remove-button class="cart-drawer__item-remove">
                      <a href="{{ item.url_to_remove }}" aria-label="{{ 'sections.cart.remove_title' | t: title: item.title | escape }}" data-cart-remove data-item-key="{{ item.key }}">
                        {{ 'sections.cart.remove' | t }}
                      </a>
                    </cart-remove-button>
                  </div>
                </div>
              </div>
            {%- endfor -%}
          </div>

          <div class="cart-drawer__footer">
            {%- if settings.cart_show_free_shipping_bar -%}
              {%- assign free_shipping_threshold = settings.cart_free_shipping_threshold | times: 100 -%}
              {%- if free_shipping_threshold > 0 -%}
                <free-shipping-bar class="cart-drawer__free-shipping" data-threshold="{{ free_shipping_threshold }}">
                  {%- if cart.total_price < free_shipping_threshold -%}
                    {%- assign remaining = free_shipping_threshold | minus: cart.total_price -%}
                    <div class="free-shipping-bar">
                      <p class="free-shipping-bar__text">
                        {{ 'sections.cart.free_shipping_remaining' | t: amount: remaining | money }}
                      </p>
                      <div class="free-shipping-bar__progress">
                        <div class="free-shipping-bar__progress-bar" style="width: {{ cart.total_price | times: 100 | divided_by: free_shipping_threshold }}%"></div>
                      </div>
                    </div>
                  {%- else -%}
                    <div class="free-shipping-bar free-shipping-bar--complete">
                      <p class="free-shipping-bar__text">
                        {% render 'icon', icon: 'check' %}
                        {{ 'sections.cart.free_shipping_eligible' | t }}
                      </p>
                    </div>
                  {%- endif -%}
                </free-shipping-bar>
              {%- endif -%}
            {%- endif -%}

            <div class="cart-drawer__subtotal">
              <span class="cart-drawer__subtotal-title">{{ 'sections.cart.subtotal' | t }}</span>
              <span class="cart-drawer__subtotal-price" data-cart-subtotal>{{ cart.total_price | money_with_currency }}</span>
            </div>

            {%- if cart.cart_level_discount_applications.size > 0 -%}
              <div class="cart-drawer__discounts" data-cart-discounts>
                {%- for discount in cart.cart_level_discount_applications -%}
                  <div class="cart-drawer__discount">
                    {% render 'icon', icon: 'sale' %}
                    {{ discount.title }}
                    (-{{ discount.total_allocated_amount | money }})
                  </div>
                {%- endfor -%}
              </div>
            {%- endif -%}

            <p class="cart-drawer__tax-note caption">
              {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                {{ 'sections.cart.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}
              {%- elsif cart.taxes_included -%}
                {{ 'sections.cart.taxes_included_but_shipping_at_checkout' | t }}
              {%- elsif shop.shipping_policy.body != blank -%}
                {{ 'sections.cart.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}
              {%- else -%}
                {{ 'sections.cart.taxes_and_shipping_at_checkout' | t }}
              {%- endif -%}
            </p>

            <div class="cart-drawer__buttons">
              <a href="{{ routes.cart_url }}" class="button button--secondary">
                {{ 'sections.cart.view_cart' | t }}
              </a>
              <button type="submit" name="checkout" class="button button--primary" form="CartDrawer">
                {{ 'sections.cart.checkout' | t }}
              </button>
            </div>
          </div>
        </form>
      {%- else -%}
        <div class="cart-drawer__empty">
          <div class="cart-drawer__empty-content">
            <h3>{{ 'sections.cart.empty' | t }}</h3>
            <a href="{{ routes.all_products_collection_url }}" class="button">
              {{ 'general.continue_shopping' | t }}
            </a>
          </div>
        </div>
      {%- endif -%}
    </div>
  </div>
</cart-drawer>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const cartDrawer = document.querySelector('cart-drawer');
    const openButtons = document.querySelectorAll('[data-cart-drawer-open]');
    const closeButtons = document.querySelectorAll('[data-cart-drawer-close]');
    
    openButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        cartDrawer.classList.add('is-open');
        document.body.style.overflow = 'hidden';
      });
    });
    
    closeButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        cartDrawer.classList.remove('is-open');
        document.body.style.overflow = '';
      });
    });
  });
</script>
