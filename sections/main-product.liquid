{{ 'section-main-product.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-rte.css' | asset_url | stylesheet_tag }}
{{ 'component-loading-spinner.css' | asset_url | stylesheet_tag }}

<script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

{%- assign product = product | default: section.settings.product -%}
{%- assign current_variant = product.selected_or_first_available_variant -%}

<section class="product-main page-width section-{{ section.id }}-padding">
  <div class="product-main__inner">
    
    <!-- Product Media Gallery -->
    <div class="product-media-container" data-section="{{ section.id }}">
      <div class="product-media-list">
        {%- for media in product.media -%}
          <div class="product-media-item" data-media-id="{{ media.id }}">
            {%- case media.media_type -%}
              {%- when 'image' -%}
                {{ media | image_url: width: 1200 | image_tag:
                  widths: '375, 750, 1100, 1500, 1780, 2000, 3000',
                  sizes: '(min-width: 1200px) 715px, (min-width: 990px) calc(65vw - 10rem), (min-width: 750px) calc((100vw - 130px) / 2), calc((100vw - 50px) / 2)',
                  loading: 'lazy',
                  class: 'product-media-image'
                }}
              {%- when 'video' -%}
                {{ media | video_tag: controls: true, class: 'product-media-video' }}
              {%- when 'external_video' -%}
                {{ media | external_video_tag: class: 'product-media-external-video' }}
              {%- when 'model' -%}
                {{ media | model_viewer_tag: class: 'product-media-model' }}
            {%- endcase -%}
          </div>
        {%- endfor -%}
      </div>
      
      {%- if product.media.size > 1 -%}
        <div class="product-thumbnails">
          {%- for media in product.media limit: 8 -%}
            <button 
              class="product-thumbnail {% if forloop.first %}active{% endif %}"
              data-media-id="{{ media.id }}"
              aria-label="Load media {{ forloop.index }} in gallery view"
            >
              {{ media | image_url: width: 200 | image_tag:
                widths: '100, 200',
                loading: 'lazy',
                alt: media.alt | escape
              }}
            </button>
          {%- endfor -%}
        </div>
      {%- endif -%}
    </div>

    <!-- Product Information -->
    <div class="product-info-container">
      <div class="product-info" id="ProductInfo-{{ section.id }}">
        
        <!-- Product Title and Vendor -->
        {%- if section.settings.show_vendor -%}
          <p class="product-vendor">{{ product.vendor }}</p>
        {%- endif -%}
        
        <h1 class="product-title">{{ product.title | escape }}</h1>
        
        <!-- Product Price -->
        <div class="product-price" id="price-{{ section.id }}">
          <div class="price-item price-item--regular">
            <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
            <span class="price-money">{{ current_variant.price | money }}</span>
          </div>
          {%- if current_variant.compare_at_price > current_variant.price -%}
            <div class="price-item price-item--sale">
              <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
              <span class="price-money">{{ current_variant.compare_at_price | money }}</span>
            </div>
            {%- if section.settings.show_discount_badge -%}
              {%- assign discount = current_variant.compare_at_price | minus: current_variant.price | times: 100 | divided_by: current_variant.compare_at_price -%}
              <span class="badge badge--sale">{{ discount }}% OFF</span>
            {%- endif -%}
          {%- endif -%}
        </div>

        <!-- Product Rating -->
        {%- if section.settings.show_rating and product.metafields.reviews.rating.value -%}
          <div class="product-rating">
            {%- assign rating = product.metafields.reviews.rating.value -%}
            <div class="rating-stars" aria-label="Rated {{ rating }} out of 5">
              {%- for i in (1..5) -%}
                <span class="star {% if i <= rating %}filled{% endif %}">★</span>
              {%- endfor -%}
            </div>
            {%- if product.metafields.reviews.rating_count -%}
              <span class="rating-count">({{ product.metafields.reviews.rating_count }} reviews)</span>
            {%- endif -%}
          </div>
        {%- endif -%}

        <!-- Product Form -->
        <product-form class="product-form">
          {%- form 'product', product, id: 'ProductForm-{{ section.id }}', class: 'form' -%}
            <input type="hidden" name="id" value="{{ current_variant.id }}">
            
            <!-- Variant Picker -->
            {%- unless product.has_only_default_variant -%}
              <variant-picker data-section="{{ section.id }}" data-url="{{ product.url }}">
                {%- for option in product.options_with_values -%}
                  <fieldset class="variant-input-wrapper">
                    <legend class="form-label">{{ option.name }}</legend>
                    
                    {%- if section.settings.picker_type == 'button' -%}
                      <div class="variant-input-buttons">
                        {%- for value in option.values -%}
                          <input
                            type="radio"
                            id="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}"
                            name="{{ option.name }}"
                            value="{{ value | escape }}"
                            form="ProductForm-{{ section.id }}"
                            {% if option.selected_value == value %}checked{% endif %}
                          >
                          <label for="{{ section.id }}-{{ option.position }}-{{ forloop.index0 }}">
                            {{ value }}
                          </label>
                        {%- endfor -%}
                      </div>
                    {%- else -%}
                      <div class="variant-input-dropdown">
                        <select
                          id="Option-{{ section.id }}-{{ option.position }}"
                          name="options[{{ option.name | escape }}]"
                          form="ProductForm-{{ section.id }}"
                        >
                          {%- for value in option.values -%}
                            <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
                              {{ value }}
                            </option>
                          {%- endfor -%}
                        </select>
                      </div>
                    {%- endif -%}
                  </fieldset>
                {%- endfor -%}
              </variant-picker>
            {%- endunless -%}

            <!-- Quantity Selector -->
            <div class="product-form__quantity">
              <label for="Quantity-{{ section.id }}" class="form-label">{{ 'products.product.quantity.label' | t }}</label>
              <quantity-input class="quantity">
                <button class="quantity-button" type="button" name="minus" aria-label="Decrease quantity">−</button>
                <input
                  type="number"
                  name="quantity"
                  id="Quantity-{{ section.id }}"
                  min="1"
                  value="1"
                  form="ProductForm-{{ section.id }}"
                >
                <button class="quantity-button" type="button" name="plus" aria-label="Increase quantity">+</button>
              </quantity-input>
            </div>

            <!-- Add to Cart Button -->
            <div class="product-form__buttons">
              <button
                type="submit"
                name="add"
                class="product-form__submit button button--full-width {% if section.settings.enable_dynamic_checkout %}button--secondary{% else %}button--primary{% endif %}"
                {% if current_variant.available == false %}disabled{% endif %}
              >
                <span>
                  {%- if current_variant.available -%}
                    {{ 'products.product.add_to_cart' | t }}
                  {%- else -%}
                    {{ 'products.product.sold_out' | t }}
                  {%- endif -%}
                </span>
                <div class="loading-overlay__spinner hidden">
                  <svg class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                    <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                  </svg>
                </div>
              </button>
              
              {%- if section.settings.enable_dynamic_checkout -%}
                {{ form | payment_button }}
              {%- endif -%}
            </div>
          {%- endform -%}
        </product-form>

        <!-- Product Description -->
        {%- if product.description != blank -%}
          <div class="product-description rte">
            {{ product.description }}
          </div>
        {%- endif -%}

        <!-- Accordion Items -->
        {%- if section.blocks.size > 0 -%}
          <div class="product-accordions">
            {%- for block in section.blocks -%}
              {%- case block.type -%}
                {%- when 'collapsible_tab' -%}
                  <details class="accordion" {{ block.shopify_attributes }}>
                    <summary class="accordion__title">
                      {{ block.settings.heading | default: block.settings.page.title }}
                      <span class="accordion__icon">
                        <svg width="20" height="20" viewBox="0 0 20 20">
                          <path d="M10 14L5 9l1.41-1.41L10 11.17l3.59-3.58L15 9z" fill="currentColor"/>
                        </svg>
                      </span>
                    </summary>
                    <div class="accordion__content rte">
                      {{ block.settings.content }}
                      {{ block.settings.page.content }}
                    </div>
                  </details>
                {%- when 'popup' -%}
                  <modal-opener class="product-popup-modal__opener" data-modal="#PopupModal-{{ block.id }}">
                    <button type="button" class="link" aria-haspopup="dialog" {{ block.shopify_attributes }}>
                      {{ block.settings.text | default: block.settings.page.title }}
                    </button>
                  </modal-opener>
                {%- when '@app' -%}
                  {% render block %}
              {%- endcase -%}
            {%- endfor -%}
          </div>
        {%- endif -%}
        
      </div>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "t:sections.main-product.name",
  "tag": "section",
  "class": "section-main-product",
  "blocks": [
    {
      "type": "collapsible_tab",
      "name": "t:sections.main-product.blocks.collapsible_tab.name",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "default": "Collapsible row",
          "label": "t:sections.main-product.blocks.collapsible_tab.settings.heading.label"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "t:sections.main-product.blocks.collapsible_tab.settings.content.label"
        },
        {
          "type": "page",
          "id": "page",
          "label": "t:sections.main-product.blocks.collapsible_tab.settings.page.label"
        }
      ]
    },
    {
      "type": "popup",
      "name": "t:sections.main-product.blocks.popup.name",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "default": "Pop-up link text",
          "label": "t:sections.main-product.blocks.popup.settings.text.label"
        },
        {
          "type": "page",
          "id": "page",
          "label": "t:sections.main-product.blocks.popup.settings.page.label"
        }
      ]
    },
    {
      "type": "@app"
    }
  ],
  "settings": [
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "t:sections.main-product.settings.show_vendor.label"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": true,
      "label": "Show product rating"
    },
    {
      "type": "checkbox",
      "id": "show_discount_badge",
      "default": true,
      "label": "Show discount percentage"
    },
    {
      "type": "checkbox",
      "id": "enable_dynamic_checkout",
      "default": true,
      "label": "Show dynamic checkout buttons"
    },
    {
      "type": "select",
      "id": "picker_type",
      "options": [
        {
          "value": "dropdown",
          "label": "Dropdown"
        },
        {
          "value": "button",
          "label": "Button"
        }
      ],
      "default": "button",
      "label": "Variant picker type"
    }
  ]
}
{% endschema %}
